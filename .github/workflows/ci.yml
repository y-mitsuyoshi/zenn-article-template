name: CI - Quality Checks

on:
  pull_request:
    branches:
      - main
    paths:
      - 'articles/**'
      - 'books/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  zenn-build-check:
    name: Zennè¨˜æ³•ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Zenn build
        run: npm run lint:zenn

  textlint-check:
    name: æ—¥æœ¬èªæ ¡æ­£ (textlint)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run textlint
        id: textlint
        continue-on-error: true
        run: |
          npm run lint:text > textlint-result.txt 2>&1 || true
          cat textlint-result.txt

      - name: Check textlint result
        id: check-result
        run: |
          if grep -q "âœ–.*problems" textlint-result.txt; then
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with textlint results
        if: steps.check-result.outputs.has_errors == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const result = fs.readFileSync('textlint-result.txt', 'utf8');
            
            const body = `## ğŸ“ textlint æ¤œå‡ºçµæœ
            
            ä»¥ä¸‹ã®æ—¥æœ¬èªè¡¨è¨˜ã«é–¢ã™ã‚‹æŒ‡æ‘˜ãŒã‚ã‚Šã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚
            
            <details>
            <summary>è©³ç´°ã‚’è¡¨ç¤º</summary>
            
            \`\`\`
            ${result}
            \`\`\`
            
            </details>
            
            > **Note**: ã“ã‚Œã¯å‚è€ƒæƒ…å ±ã§ã™ã€‚ã™ã¹ã¦ã®æŒ‡æ‘˜ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚æ–‡è„ˆã«å¿œã˜ã¦åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Upload textlint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: textlint-results
          path: textlint-result.txt
          retention-days: 30
